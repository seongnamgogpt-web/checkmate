import os
import streamlit as st
from openai import OpenAI
from utils import extract_text_from_uploaded_file

# ==============================
# ì´ˆê¸° ì„¤ì •
# ==============================
try:
    from dotenv import load_dotenv
    load_dotenv()
except:
    pass

API_KEY = os.getenv("OPENAI_API_KEY", st.secrets.get("OPENAI_API_KEY", None))
if not API_KEY:
    st.error("âŒ OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    st.stop()

client = OpenAI(api_key=API_KEY)

# ==============================
# Streamlit UI
# ==============================
st.set_page_config(page_title="Check Mate - ìë™ ìˆ˜í–‰í‰ê°€ ì²¨ì‚­ê¸°", layout="wide")
st.title("ğŸ§  Check Mate - ìˆ˜í–‰í‰ê°€ ìë™ í‰ê°€ ë° ì²¨ì‚­ ë„ìš°ë¯¸")

st.markdown("""
**Check Mate**ëŠ” ìˆ˜í–‰í‰ê°€ ì´ˆì•ˆì´ ì œì‹œëœ ìš”êµ¬ì¡°ê±´ì— ì–¼ë§ˆë‚˜ ë¶€í•©í•˜ëŠ”ì§€ AIê°€ ìë™ìœ¼ë¡œ í‰ê°€í•˜ê³ , 
ì‚¬ì‹¤ì„± ê²€ì¦ê³¼ ë¬¸ì¥ ì²¨ì‚­ê¹Œì§€ ìˆ˜í–‰í•©ë‹ˆë‹¤.

- âœ… ì¡°ê±´ ì¶©ì¡±
- âŒ ì¡°ê±´ ë¶ˆì¶©ì¡± (ì‚¬ì‹¤ ì˜¤ë¥˜ í¬í•¨)
- âš ï¸ ì¼ë¶€ ë¶€ì¡± ë˜ëŠ” ë¬¸ì¥ ì˜¤ë¥˜
""")

# ì¢Œìš° ë ˆì´ì•„ì›ƒ
left, right = st.columns([1, 1])

# ==============================
# ì™¼ìª½: ì…ë ¥ ì˜ì—­
# ==============================
with left:
    st.header("ğŸ“‹ ìˆ˜í–‰í‰ê°€ ìš”êµ¬ì¡°ê±´ ì…ë ¥")
    conditions = st.text_area(
        "ì¡°ê±´ì„ í•œ ì¤„ì”© ì…ë ¥í•˜ì„¸ìš”:",
        placeholder="ì˜ˆ: 1. ê¸€ì ìˆ˜ 800~1200ì\n2. ëŒ€ë¥™ì´ë™ì„¤ ì œì•ˆì ì–¸ê¸‰\n3. ê³¼í•™ì  ê·¼ê±° í¬í•¨"
    )

    st.header("ğŸ“ í•™ìƒ ì œì¶œë¬¼ ì…ë ¥")
    text_input_method = st.radio("ì…ë ¥ ë°©ì‹", ["ì§ì ‘ ì…ë ¥", "íŒŒì¼ ì—…ë¡œë“œ"])

    student_text = ""
    if text_input_method == "ì§ì ‘ ì…ë ¥":
        student_text = st.text_area("í•™ìƒ ê¸€ ì…ë ¥", height=250)
    else:
        uploaded = st.file_uploader("íŒŒì¼ ì—…ë¡œë“œ (.txt, .pdf, .docx)")
        if uploaded:
            student_text = extract_text_from_uploaded_file(uploaded)
            st.success("âœ… íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ")
            with st.expander("ğŸ“„ í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸°"):
                st.write(student_text[:1000])

    if st.button("âœ³ï¸ AI ìë™ í‰ê°€ ë° ì²¨ì‚­ ì‹¤í–‰"):
        if not conditions or not student_text:
            st.warning("âš ï¸ ì¡°ê±´ê³¼ í•™ìƒ ê¸€ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.")
        else:
            with st.spinner("AIê°€ í‰ê°€ ì¤‘ì…ë‹ˆë‹¤..."):
                prompt = f"""
                ë„ˆëŠ” ìˆ˜í–‰í‰ê°€ ì „ë¬¸ AI ì±„ì ê´€ì´ì•¼.

                ì•„ë˜ ìš”êµ¬ì¡°ê±´ê³¼ í•™ìƒ ê¸€ì„ ë³´ê³  ë‹¤ìŒì„ ìˆ˜í–‰í•´:
                1. ê° ì¡°ê±´ ì¶©ì¡± ì—¬ë¶€ íŒë‹¨ (âœ… ì¶©ì¡±, âŒ ì‚¬ì‹¤ ì˜¤ë¥˜ í¬í•¨ ë¶ˆì¶©ì¡±, âš ï¸ ì¼ë¶€ ë¶€ì¡±)
                2. ì‚¬ì‹¤ ì˜¤ë¥˜, ëª…ì¹­ ì˜¤ë¥˜, ê°œë… ì˜¤ë¥˜ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ âŒ ì²˜ë¦¬
                3. ë¬¸ë²•, í‘œí˜„, êµ¬ì¡° ë“±ì„ ìë™ ì²¨ì‚­ (ì›ë¬¸ ì˜ë¯¸ ìµœëŒ€í•œ ìœ ì§€)
                4. ì¡°ê±´ë³„ í‰ê°€ì™€ ì´ìœ , ì²¨ì‚­ ë¬¸ì¥ ì œì•ˆ í¬í•¨
                5. ìµœì¢… ì ìˆ˜ ë° ê°„ëµ ì´í‰ ì œê³µ (100ì  ë§Œì )

                [ì¡°ê±´ ëª©ë¡]
                {conditions}

                [í•™ìƒ ê¸€]
                {student_text}
                """

                response = client.chat.completions.create(
                    model="gpt-4o-mini",
                    messages=[
                        {"role": "system", "content": "ë„ˆëŠ” ìˆ˜í–‰í‰ê°€ ì±„ì ê³¼ ì²¨ì‚­ ì „ë¬¸ê°€ AIì•¼."},
                        {"role": "user", "content": prompt}
                    ],
                    temperature=0.3
                )

                result = response.choices[0].message.content
                st.session_state['evaluation_result'] = result

# ==============================
# ì˜¤ë¥¸ìª½: ê²°ê³¼ ì˜ì—­
# ==============================
with right:
    st.header("ğŸ“Š í‰ê°€ ë° ì²¨ì‚­ ê²°ê³¼")
    if 'evaluation_result' in st.session_state:
        st.markdown(st.session_state['evaluation_result'])
    else:
        st.info("ì™¼ìª½ì—ì„œ ì¡°ê±´ê³¼ í•™ìƒ ê¸€ ì…ë ¥ í›„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")

# ==============================
# í•˜ë‹¨: í‰ê°€ ì˜ˆì‹œ
# ==============================
st.markdown("---")
st.header("ğŸ§© í‰ê°€ ì˜ˆì‹œ")
with st.expander("ì˜ˆì‹œ 1"):
    st.markdown("""
**ì¡°ê±´**
1. ê¸€ì ìˆ˜ 800~1200ì
2. ëŒ€ë¥™ì´ë™ì„¤ ì œì•ˆì ì–¸ê¸‰
3. ê³¼í•™ì  ê·¼ê±° í¬í•¨

**í•™ìƒ ê¸€**
ë² ê²Œë„ˆëŠ” ëŒ€ë¥™ì´ ì´ë™í•œë‹¤ê³  ì£¼ì¥í–ˆë‹¤. í›„ì— í•´ë ¹ê³¼ íŒ êµ¬ì¡°ë¡ ìœ¼ë¡œ ì¦ëª…ë˜ì—ˆë‹¤.

**í‰ê°€ ì˜ˆì‹œ**
1. ê¸€ì ìˆ˜ â†’ âš ï¸ ì¼ë¶€ ë¶€ì¡±
2. ì œì•ˆì ì–¸ê¸‰ â†’ âœ… ì¶©ì¡±
3. ê·¼ê±° ì œì‹œ â†’ âœ… ì¶©ì¡±

ì´ì : 85ì  / ì´í‰: ì¼ë¶€ ì¡°ê±´ ë¶€ì¡± ìˆìœ¼ë‚˜ ê³¼í•™ì  íƒ€ë‹¹ì„±ì€ ë†’ìŒ.
""")
with st.expander("ì˜ˆì‹œ 2"):
    st.markdown("""
**ì¡°ê±´**
1. ì„¸ì¢…ëŒ€ì™• ì—…ì  2ê°€ì§€ ì´ìƒ ì–¸ê¸‰
2. ì‚¬íšŒì  ì˜ë¯¸ ì„œìˆ 

**í•™ìƒ ê¸€**
ì„¸ì¢…ëŒ€ì™•ì€ í›ˆë¯¼ì •ìŒì„ ì°½ì œí•˜ê³  ì¸¡ìš°ê¸°ë¥¼ ë§Œë“¤ì—ˆë‹¤.

**í‰ê°€ ì˜ˆì‹œ**
1. ì—…ì  ì–¸ê¸‰ â†’ âœ… ì¶©ì¡±
2. ì‚¬íšŒì  ì˜ë¯¸ â†’ âŒ ì‚¬ì‹¤ ì˜¤ë¥˜ (ì¸¡ìš°ê¸°ëŠ” ì¥ì˜ì‹¤ ì œì‘)

ì´ì : 80ì  / ì´í‰: ì¼ë¶€ ì‚¬ì‹¤ ì˜¤ë¥˜ ì¡´ì¬.
""")
with st.expander("ì˜ˆì‹œ 3"):
    st.markdown("""
**ì¡°ê±´**
1. ì‹¤í—˜ ê³¼ì • ì •í™• ì œì‹œ
2. ê²°ê³¼ ì›ì¸ ë¶„ì„

**í•™ìƒ ê¸€**
ì˜¨ë„ì— ë”°ë¼ ìš©í•´ë„ ë³€í™”ë¥¼ ê´€ì°°í–ˆìœ¼ë‚˜ ìˆœì„œ ë¶ˆëª…í™•.

**í‰ê°€ ì˜ˆì‹œ**
1. ì‹¤í—˜ ìˆœì„œ â†’ âŒ ë¶€ì¡±
2. ê²°ê³¼ ë¶„ì„ â†’ âœ… ì¶©ì¡±

ì´ì : 75ì  / ì´í‰: ë¶„ì„ë ¥ì€ ìš°ìˆ˜í•˜ì§€ë§Œ ì ˆì°¨ êµ¬ì²´ì„± ë¶€ì¡±.
""")

